generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  EMPLOYEE
  MANAGER
  ADMIN
  CONTENT_CREATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
  VERIFICATION_PENDING  // Added for manager verification
}

enum ContentSource {
  CUSTOM
  EXTERNAL
}

enum LearningPathStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  UNDER_REVIEW
}

enum EnrollmentStatus {
  ENROLLED
  IN_PROGRESS
  COMPLETED
  DROPPED
  PAUSED
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}



enum AchievementType {
  COMPLETION
  STREAK
  SPEED
  SCORE
  SOCIAL
  MILESTONE
  CUSTOM
  MASTERY
}

enum AchievementRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
  MYTHIC
}

enum PointsTransactionType {
  EARNED
  SPENT
  BONUS
  PENALTY
  ADJUSTMENT
  REFUND
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  ALL_TIME
}

enum NotificationType {
  ACHIEVEMENT
  STREAK
  MODULE_COMPLETION
  PATH_COMPLETION
  LEADERBOARD
  SYSTEM
  REMINDER
  ASSIGNMENT
  DEADLINE
  SOCIAL
  VERIFICATION  // Added for verification notifications
  WELCOME       // Added for welcome emails
  PASSWORD_RESET // Added for password reset
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
  DELETED
}

enum ActivityType {
  MODULE_STARTED
  MODULE_COMPLETED
  QUIZ_PASSED
  QUIZ_FAILED
  ACHIEVEMENT_EARNED
  STREAK_MILESTONE
  LEVEL_UP
  CERTIFICATE_EARNED
  PATH_ENROLLED
  PATH_COMPLETED
  BADGE_EARNED
  POINTS_EARNED
  SOCIAL_INTERACTION
  ACCOUNT_VERIFIED // Added for verification activity
  PROFILE_UPDATED  // Added for profile updates
  PASSWORD_CHANGED // Added for password changes
  USER_LOGIN       // Added for login activity
  USER_LOGOUT      // Added for logout activity
  VERIFICATION_SENT
  VERIFICATION_RESENT
  EMAIL_VERIFIED
  PASSWORD_CHANGED_FORCED
  PASSWORD_RESET_BY_ADMIN
  PASSWORD_RESET_REQUESTED
  USER_DEACTIVATED
}

enum ContentType {
  TEXT
  VIDEO
  AUDIO
  INTERACTIVE
  DOCUMENT
  QUIZ
  ASSESSMENT
  EXTERNAL_LINK
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

model User {
  id                String             @id @default(uuid()) @db.VarChar(36)
  email             String             @unique @db.VarChar(191)
  password          String             @db.VarChar(255)
  firstName         String             @db.VarChar(100)
  lastName          String             @db.VarChar(100)
  employeeId        String?            @unique @db.VarChar(50)
  phone             String?            @db.VarChar(20)
  avatar            String?            @db.VarChar(500)
  departmentId      String?            @db.VarChar(36)
  department        Department?        @relation("UserDepartment", fields: [departmentId], references: [id], onDelete: SetNull)
  managedDepartment Department[]       @relation("DepartmentManager")
  jobTitle          String?            @db.VarChar(100)
  managerId         String?            @db.VarChar(36)
  manager           User?              @relation("ManagerToEmployee", fields: [managerId], references: [id], onDelete: SetNull)
  subordinates      User[]             @relation("ManagerToEmployee")
  role              UserRole           @default(EMPLOYEE)
  status            UserStatus         @default(PENDING)

  totalPoints       Int                @default(0)
  currentLevel      Int                @default(1)
  currentStreak     Int                @default(0)
  longestStreak     Int                @default(0)
  lastActiveDate    DateTime?

  // Email verification fields
  emailVerified     Boolean            @default(false)
  emailVerifiedAt   DateTime?
  emailVerificationCode     String?    @db.VarChar(10)
  emailVerificationExpiry   DateTime?
  
  twoFactorEnabled  Boolean            @default(false)
  twoFactorSecret   String?            @db.VarChar(100)
  passwordChangedAt DateTime?
  mustChangePassword Boolean           @default(false)

  // Account creation tracking
  createdBy         String?            @db.VarChar(36)
  creator           User?              @relation("UserCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  createdUsers      User[]             @relation("UserCreator")

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastLoginAt       DateTime?

  // Relations
  enrollments       Enrollment[]
  moduleProgress    ModuleProgress[]
  achievements      UserAchievement[]
  badges            UserBadge[]
  notifications     Notification[]
  activities        Activity[]
  quizAttempts      QuizAttempt[]
  certificates      Certificate[]
  preferences       UserPreference?
  sessions          Session[]
  streakHistory     StreakHistory[]
  pointsHistory     PointsTransaction[]
  cohortMembers     CohortMember[]
  createdPaths      LearningPath[]     @relation("LearningPathCreator")
  assignedPaths     AssignedLearningPath[]
  assignedLearningPaths AssignedLearningPath[] @relation("LearningPathAssigner")
  cohortAssignments CohortAssignment[]
  auditLogs         AuditLog[]
  contentVersions   ContentVersion[]
  emailVerifications EmailVerification[] // Added for email verification tracking
  
  // Chat relations
  messages          Message[]
  conversations     Participant[]
  
  @@index([email])
  @@index([employeeId])
  @@index([managerId])
  @@index([departmentId])
  @@index([status])
  @@index([createdAt])
  @@index([role])
  @@index([createdBy])
  @@map("users")
}

model Department {
  id              String            @id @default(uuid()) @db.VarChar(36)
  name            String            @unique @db.VarChar(100)
  description     String?           @db.Text
  managerId       String?           @db.VarChar(36)
  manager         User?             @relation("DepartmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  
  users           User[]            @relation("UserDepartment")
  cohorts         Cohort[]          @relation("CohortDepartment")
  
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([managerId])
  @@index([isActive])
  @@map("departments")
}

model EmailVerification {
  id              String   @id @default(uuid()) @db.VarChar(36)
  userId          String   @unique @db.VarChar(36)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code            String   @db.VarChar(10)
  expiresAt       DateTime
  attempts        Int      @default(0)
  createdAt       DateTime @default(now())
  
  @@index([code])
  @@index([expiresAt])
  @@index([userId])
  @@map("email_verifications")
}

model UserPreference {
  id                   String   @id @default(uuid()) @db.VarChar(36)
  userId               String   @unique @db.VarChar(36)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  learningStyle        String?  @default("visual") @db.VarChar(20)
  preferredDifficulty  String?  @default("intermediate") @db.VarChar(20)
  sessionDuration      Int?     @default(60)
  dailyGoalMinutes     Int?     @default(120)
  autoAdvance          Boolean  @default(true)

  emailNotifications   Boolean  @default(true)
  pushNotifications    Boolean  @default(true)
  achievementAlerts    Boolean  @default(true)
  weeklyReport         Boolean  @default(true)
  streakReminders      Boolean  @default(true)
  assignmentAlerts     Boolean  @default(true)

  shareProgress        Boolean  @default(true)
  showOnLeaderboard    Boolean  @default(true)
  allowAnalytics       Boolean  @default(true)
 
  theme                String   @default("light") @db.VarChar(10)
  language             String   @default("en") @db.VarChar(10)
  fontSize             String   @default("medium") @db.VarChar(10)
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@map("user_preferences")
}

model Session {
  id           String   @id @default(uuid()) @db.VarChar(36)
  userId       String   @db.VarChar(36)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique @db.VarChar(500)
  ipAddress    String?  @db.VarChar(45)
  userAgent    String?  @db.Text
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model LearningPath {
  id                    String              @id @default(uuid()) @db.VarChar(36)
  title                 String              @db.VarChar(200)
  description           String              @db.Text
  shortDescription      String?             @db.VarChar(500)
  slug                  String              @unique @db.VarChar(200)
  categoryId            String?             @db.VarChar(36)
  subCategoryId         String?             @db.VarChar(36)
  
  categoryRef           Category?           @relation("PathCategory", fields: [categoryId], references: [id], onDelete: SetNull)
  subcategoryRef        SubCategory?        @relation("PathSubCategory", fields: [subCategoryId], references: [id], onDelete: SetNull)

  difficulty            DifficultyLevel     @default(BEGINNER)
  estimatedHours        Float
  minEstimatedHours     Float?
  maxEstimatedHours     Float?
 
  source                ContentSource       @default(CUSTOM)
  status                LearningPathStatus  @default(DRAFT)
  provider              String              @default("Vizx Academy") @db.VarChar(50)

  thumbnailUrl          String?             @db.VarChar(500)
  bannerUrl             String?             @db.VarChar(500)
  iconUrl               String?             @db.VarChar(500)

  prerequisites         Json?
  learningObjectives    Json?
  tags                  Json?
  skills                Json?             
  
  createdBy             String?            @db.VarChar(36)
  creator               User?              @relation("LearningPathCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  isPublic              Boolean            @default(true)
  isFeatured            Boolean            @default(false)
  featuredOrder         Int?               @default(0)

  externalUrl           String?            @db.VarChar(500)
  lastSyncedAt          DateTime?
  version               String?            @db.VarChar(20)
  completionPoints      Int                @default(500)

  enrollmentCount       Int                @default(0)
  completionCount       Int                @default(0)
  averageRating         Float?
  ratingCount           Int                @default(0)
  averageCompletionTime Float?
  popularityScore       Float?             @default(0)

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  publishedAt           DateTime?

  modules               Module[]
  enrollments           Enrollment[]
  assignments           AssignedLearningPath[]
  cohortAssignments     CohortAssignment[]
  certificates          Certificate[]
  
  @@index([categoryId])
  @@index([subCategoryId])
  @@index([difficulty])
  @@index([status])
  @@index([source])
  @@index([isFeatured])
  @@index([createdBy])
  @@index([createdAt])
  @@map("learning_paths")
}

model Module {
  id                    String              @id @default(uuid()) @db.VarChar(36)
  learningPathId        String              @db.VarChar(36)
  learningPath          LearningPath        @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  
  title                 String              @db.VarChar(200)
  description           String              @db.Text
  shortDescription      String?             @db.VarChar(500)
  slug                  String              @db.VarChar(200)
  orderIndex            Int                 @default(0)
  category              String?             @db.VarChar(100)

  // Make content properly nullable for non-text content types
  content               String?             @db.LongText 
  contentType           ContentType         @default(TEXT)
  difficulty            DifficultyLevel     @default(BEGINNER)
  estimatedMinutes      Int
  minEstimatedMinutes   Int?
  maxEstimatedMinutes   Int?

  // Add dedicated fields for different content types
  videoUrl              String?             @db.VarChar(500)
  audioUrl              String?             @db.VarChar(500)
  documentUrl           String?             @db.VarChar(500)
  externalLink          String?             @db.VarChar(500)
  
  thumbnailUrl          String?             @db.VarChar(500)
  resources             Json?             
  attachments           Json?            

  // Remove the generic externalUrl since we have specific fields now
  lastSyncedAt          DateTime?
  version               String?            @db.VarChar(20)

  isActive              Boolean            @default(true)
  isOptional            Boolean            @default(false)
  requiresCompletion    Boolean            @default(true)

  prerequisites         Json?
  learningObjectives    Json?
  tags                  Json?
  keyConcepts           Json?

  completionPoints      Int                @default(100)
  maxQuizAttempts       Int?               @default(3)

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  progress              ModuleProgress[]
  quizzes               Quiz[]
  
  @@unique([learningPathId, slug])
  @@unique([learningPathId, orderIndex])
  @@index([learningPathId])
  @@index([difficulty])
  @@index([isActive])
  @@index([orderIndex])
  @@map("modules")
}

model Enrollment {
  id              String           @id @default(uuid()) @db.VarChar(36)
  userId          String           @db.VarChar(36)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  learningPathId  String           @db.VarChar(36)
  learningPath    LearningPath     @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  
  status          EnrollmentStatus @default(ENROLLED)
  progress        Float            @default(0)
 
  enrolledAt      DateTime         @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  lastAccessedAt  DateTime?
  dueDate         DateTime?      

  totalTimeSpent  Int              @default(0)
  lastActivityAt  DateTime?

  certificateId   String?          @db.VarChar(36)
  finalScore      Float?
  completionNotes String?          @db.Text

  moduleProgress  ModuleProgress[]
  quizAttempts    QuizAttempt[]
  
  @@unique([userId, learningPathId])
  @@index([userId])
  @@index([learningPathId])
  @@index([status])
  @@index([enrolledAt])
  @@index([dueDate])
  @@map("enrollments")
}

model AssignedLearningPath {
  id              String           @id @default(uuid()) @db.VarChar(36)
  learningPathId  String           @db.VarChar(36)
  learningPath    LearningPath     @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  userId          String           @db.VarChar(36)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedById    String           @db.VarChar(36)
  assignedBy      User             @relation("LearningPathAssigner", fields: [assignedById], references: [id], onDelete: Cascade)

  dueDate         DateTime?
  instructions    String?          @db.Text
  isRequired      Boolean          @default(false)
  priority        String           @default("NORMAL") @db.VarChar(20)

  status          EnrollmentStatus @default(ENROLLED)

  assignedAt      DateTime         @default(now())
  acknowledgedAt  DateTime?
  completedAt     DateTime?
  
  @@unique([userId, learningPathId])
  @@index([userId])
  @@index([learningPathId])
  @@index([assignedById])
  @@index([dueDate])
  @@index([status])
  @@map("assigned_learning_paths")
}

model ModuleProgress {
  id              String         @id @default(uuid()) @db.VarChar(36)
  userId          String         @db.VarChar(36)
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  moduleId        String         @db.VarChar(36)
  module          Module         @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  enrollmentId    String         @db.VarChar(36)
  enrollment      Enrollment     @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  status          ProgressStatus @default(NOT_STARTED)
  progress        Float          @default(0)

  timeSpent       Int            @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  lastAccessedAt  DateTime?
 
  quizScore       Float?
  attempts        Int            @default(0)
  bestScore       Float?

  pointsEarned    Int            @default(0)

  notes           String?        @db.Text
  bookmarked      Boolean        @default(false)
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@unique([userId, moduleId, enrollmentId])
  @@index([userId])
  @@index([moduleId])
  @@index([enrollmentId])
  @@index([status])
  @@index([completedAt])
  @@map("module_progress")
}

model Quiz {
  id                String         @id @default(uuid()) @db.VarChar(36)
  moduleId          String         @db.VarChar(36)
  module            Module         @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  title             String         @db.VarChar(200)
  description       String?        @db.Text
  instructions      String?        @db.Text
  timeLimit         Int?
  passingScore      Float          @default(70)
  maxAttempts       Int?           @default(3)
  shuffleQuestions  Boolean        @default(true)
  showResults       Boolean        @default(true)
  allowRetake       Boolean        @default(true)

  questions         Json
  questionSettings  Json?        

  pointsAvailable   Int            @default(100)
  difficultyBonus   Int?           @default(0)
  
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  attempts          QuizAttempt[]
  
  @@index([moduleId])
  @@index([isActive])
  @@map("quizzes")
}

model QuizAttempt {
  id              String   @id @default(uuid()) @db.VarChar(36)
  userId          String   @db.VarChar(36)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizId          String   @db.VarChar(36)
  quiz            Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  enrollmentId    String   @db.VarChar(36)
  enrollment      Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  attemptNumber   Int      @default(1)
  score           Float
  passed          Boolean
  percentage      Float   
  
  answers         Json
  questions       Json     
  detailedResults Json?    
  
  timeSpent       Int     
  startedAt       DateTime
  completedAt     DateTime @default(now())

  gradedBy        String?  @db.VarChar(36)
  gradedAt        DateTime?
  feedback        String?  @db.Text
  
  @@index([userId])
  @@index([quizId])
  @@index([enrollmentId])
  @@index([attemptNumber])
  @@index([completedAt])
  @@map("quiz_attempts")
}

model Achievement {
  id              String             @id @default(uuid()) @db.VarChar(36)
  title           String             @db.VarChar(200)
  description     String             @db.Text
  type            AchievementType
  rarity          AchievementRarity  @default(COMMON)

  requirement     Json
  points          Int                @default(100)
  level           Int?               @default(1)
  category        String?            @db.VarChar(50)

  icon            String?            @db.VarChar(100)
  badgeUrl        String?            @db.VarChar(500)
  color           String?            @db.VarChar(20)

  isActive        Boolean            @default(true)
  isSecret        Boolean            @default(false)
  isStackable     Boolean            @default(false)
  maxProgress     Float?            
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  userAchievements UserAchievement[]
  
  @@index([type])
  @@index([rarity])
  @@index([category])
  @@index([isActive])
  @@map("achievements")
}

model UserAchievement {
  id              String      @id @default(uuid()) @db.VarChar(36)
  userId          String      @db.VarChar(36)
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId   String      @db.VarChar(36)
  achievement     Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  progress        Float?      @default(0)
  currentLevel    Int?        @default(1)
  isUnlocked      Boolean     @default(false)
  unlockedAt      DateTime?
  earnedAt        DateTime?
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([isUnlocked])
  @@map("user_achievements")
}

model Badge {
  id          String      @id @default(uuid()) @db.VarChar(36)
  name        String      @db.VarChar(100)
  description String      @db.Text
  imageUrl    String?     @db.VarChar(500)
  points      Int         @default(0)
  requirement Json
  category    String?     @db.VarChar(50)
  tier        String?     @default("BRONZE") @db.VarChar(20)
  
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  userBadges  UserBadge[]
  
  @@index([category])
  @@index([tier])
  @@map("badges")
}

model UserBadge {
  id        String   @id @default(uuid()) @db.VarChar(36)
  userId    String   @db.VarChar(36)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String   @db.VarChar(36)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  earnedAt  DateTime @default(now())
  sharedAt  DateTime?
  
  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

model StreakHistory {
  id          String   @id @default(uuid()) @db.VarChar(36)
  userId      String   @db.VarChar(36)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date        DateTime @db.Date
  completed   Boolean  @default(true)
  activityCount Int    @default(1)
  
  createdAt   DateTime @default(now())
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("streak_history")
}

model PointsTransaction {
  id          String                @id @default(uuid()) @db.VarChar(36)
  userId      String                @db.VarChar(36)
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        PointsTransactionType
  amount      Int
  balance     Int

  source      String                @db.VarChar(50)
  sourceId    String?               @db.VarChar(36)
  description String?               @db.VarChar(200)
  metadata    Json?               
  
  createdAt   DateTime              @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([source])
  @@index([createdAt])
  @@map("points_transactions")
}

model Leaderboard {
  id              String            @id @default(uuid()) @db.VarChar(36)
  period          LeaderboardPeriod
  startDate       DateTime
  endDate         DateTime
  name            String?           @db.VarChar(100)

  rankings        Json
  participantCount Int             @default(0)
  
  lastCalculated  DateTime          @default(now())
  nextCalculation DateTime?
  
  @@index([period])
  @@index([startDate, endDate])
  @@index([lastCalculated])
  @@map("leaderboards")
}

model Cohort {
  id              String         @id @default(uuid()) @db.VarChar(36)
  name            String         @db.VarChar(100)
  description     String?        @db.Text
  avatar          String?        @db.VarChar(500)

  type            String         @db.VarChar(20)
  departmentId    String?        @db.VarChar(36)
  department      Department?    @relation("CohortDepartment", fields: [departmentId], references: [id], onDelete: SetNull)

  isActive        Boolean        @default(true)
  isPrivate       Boolean        @default(false)
  joinCode        String?        @unique @db.VarChar(20)

  memberCount     Int            @default(0)
  activityScore   Float?         @default(0)
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  members         CohortMember[]
  assignments     CohortAssignment[]
  
  @@index([type])
  @@index([departmentId])
  @@index([isActive])
  @@map("cohorts")
}

model CohortMember {
  id        String   @id @default(uuid()) @db.VarChar(36)
  cohortId  String   @db.VarChar(36)
  cohort    Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  userId    String   @db.VarChar(36)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role      String   @default("MEMBER") @db.VarChar(20)
  joinedAt  DateTime @default(now())
  
  @@unique([cohortId, userId])
  @@index([cohortId])
  @@index([userId])
  @@map("cohort_members")
}

model CohortAssignment {
  id              String       @id @default(uuid()) @db.VarChar(36)
  cohortId        String       @db.VarChar(36)
  cohort          Cohort       @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  learningPathId  String       @db.VarChar(36)
  learningPath    LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  assignedById    String       @db.VarChar(36)
  assignedBy      User         @relation(fields: [assignedById], references: [id], onDelete: Cascade)
  
  dueDate         DateTime?
  instructions    String?      @db.Text
  isRequired      Boolean      @default(true)
  
  assignedAt      DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@unique([cohortId, learningPathId])
  @@index([cohortId])
  @@index([learningPathId])
  @@index([dueDate])
  @@map("cohort_assignments")
}

model Certificate {
  id              String   @id @default(uuid()) @db.VarChar(36)
  userId          String   @db.VarChar(36)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title           String   @db.VarChar(200)
  description     String?  @db.Text

  certificateNumber String @unique @db.VarChar(50)
  issueDate       DateTime @default(now())
  expiryDate      DateTime?
  pdfUrl          String?  @db.VarChar(500)
  template        String?  @db.VarChar(50)
  learningPathId  String?  @db.VarChar(36)
  learningPath    LearningPath? @relation(fields: [learningPathId], references: [id], onDelete: SetNull)
  moduleId        String?  @db.VarChar(36)

  verificationCode String  @unique @db.VarChar(100)
  isVerified      Boolean  @default(true)
  issuedBy        String   @default("AI Learning Hub") @db.VarChar(100)
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([certificateNumber])
  @@index([issueDate])
  @@index([learningPathId])
  @@map("certificates")
}

model Notification {
  id          String             @id @default(uuid()) @db.VarChar(36)
  userId      String             @db.VarChar(36)
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  status      NotificationStatus @default(UNREAD)
  
  title       String             @db.VarChar(200)
  message     String             @db.Text
  summary     String?            @db.VarChar(500)

  actionUrl   String?            @db.VarChar(500)
  actionLabel String?            @db.VarChar(50)

  metadata    Json?
  priority    String             @default("NORMAL") @db.VarChar(20)

  expiresAt   DateTime?
  scheduledAt DateTime?
  
  createdAt   DateTime           @default(now())
  readAt      DateTime?
  archivedAt  DateTime?
  
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("notifications")
}

model Activity {
  id          String       @id @default(uuid()) @db.VarChar(36)
  userId      String       @db.VarChar(36)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        ActivityType
  description String       @db.Text

  metadata    Json?

  pointsEarned Int?

  isPublic    Boolean      @default(true)
  
  createdAt   DateTime     @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([isPublic])
  @@map("activities")
}

model SystemConfiguration {
  id                      String   @id @default(uuid()) @db.VarChar(36)
  key                     String   @unique @db.VarChar(100)
  value                   String   @db.Text
  description             String?  @db.Text
  
  valueType               String   @default("string") @db.VarChar(20)
  
  isEditable              Boolean  @default(true)
  category                String?  @db.VarChar(50)
  group                   String?  @db.VarChar(50)
  
  updatedAt               DateTime @updatedAt
  updatedBy               String?  @db.VarChar(36)
  
  @@index([category])
  @@index([group])
  @@map("system_configurations")
}

model AuditLog {
  id          String   @id @default(uuid()) @db.VarChar(36)
  userId      String?  @db.VarChar(36)
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action      String   @db.VarChar(100)
  entity      String   @db.VarChar(50)
  entityId    String?  @db.VarChar(36)
  
  oldValue    Json?
  newValue    Json?
  changes     Json?
  
  ipAddress   String?  @db.VarChar(45)
  userAgent   String?  @db.Text
  location    String?  @db.VarChar(100)
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ContentVersion {
  id          String   @id @default(uuid()) @db.VarChar(36)
  entityType  String   @db.VarChar(50)
  entityId    String   @db.VarChar(36)
  
  version     String   @db.VarChar(20)
  title       String   @db.VarChar(200)
  content     Json
  changes     Json?
  
  createdBy   String   @db.VarChar(36)
  creator     User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  
  @@index([entityType, entityId])
  @@index([createdBy])
  @@index([createdAt])
  @@map("content_versions")
}

model Tag {
  id          String   @id @default(uuid()) @db.VarChar(36)
  name        String   @unique @db.VarChar(50)
  category    String?  @db.VarChar(50)
  description String?  @db.Text
  color       String?  @db.VarChar(20)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([name])
  @@index([category])
  @@map("tags")
}

model Category {
  id            String        @id @default(uuid()) @db.VarChar(36)
  name          String        @unique @db.VarChar(100)
  slug          String        @unique @db.VarChar(100)
  description   String?       @db.Text
  iconUrl       String?       @db.VarChar(500)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  subcategories SubCategory[]
  learningPaths LearningPath[] @relation("PathCategory")

  @@map("categories")
}

model SubCategory {
  id            String        @id @default(uuid()) @db.VarChar(36)
  categoryId    String        @db.VarChar(36)
  category      Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name          String        @db.VarChar(100)
  slug          String        @db.VarChar(100)
  description   String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  learningPaths LearningPath[] @relation("PathSubCategory")

  @@unique([categoryId, name])
  @@unique([categoryId, slug])
  @@map("sub_categories")
}

model Conversation {
  id          String             @id @default(uuid()) @db.VarChar(36)
  title       String?            @db.VarChar(200)
  isGroup     Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  messages    Message[]
  participants Participant[]

  @@map("conversations")
}

model Participant {
  id             String       @id @default(uuid()) @db.VarChar(36)
  conversationId String       @db.VarChar(36)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String       @db.VarChar(36)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime     @default(now())

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
  @@map("participants")
}

model Message {
  id             String       @id @default(uuid()) @db.VarChar(36)
  conversationId String       @db.VarChar(36)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String       @db.VarChar(36)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  content        String       @db.Text
  type           MessageType  @default(TEXT)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}
